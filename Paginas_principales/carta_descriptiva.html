<!DOCTYPE html>
<html lang="es">
<head>
    <script src="../sistema_central/auth.js" defer></script>
    <script src="../sistema_central/ec0301-data-manager.js" defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Carta Descriptiva EC0301 - Sistema Profesional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/docx@7.8.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        /* (Tu CSS de 600+ l√≠neas va aqu√≠ - Omitido por brevedad, usa el que ya tienes) */
        :root { 
            --primary: #1E3A8A; --accent: #FF6B35; --success: #22C55E; --warning: #F59E0B;
            --danger: #EF4444; --light: #F8FAFC; --border: #E5E7EB; --text: #1F2937; --muted: #6B7280;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: var(--text);
        }
        /* ... Tu CSS ... */
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <h1>
                    <i class="fa-solid fa-file-alt" style="color: var(--accent);"></i> 
                    Carta Descriptiva EC0301
                </h1>
                <div class="toolbar">
                    <a href="index.html" class="btn btn-secondary">
                        <i class="fa-solid fa-arrow-left"></i> Volver al Dashboard
                    </a>
                    <button class="btn btn-secondary" onclick="showHelp()">
                        <i class="fa-solid fa-question-circle"></i> Ayuda
                    </button>
                    <button class="btn btn-secondary" onclick="loadDraft()">
                        <i class="fa-solid fa-download"></i> Cargar
                    </button>
                    <button class="btn btn-primary" onclick="saveDraft()">
                        <i class="fa-solid fa-save"></i> Guardar
                    </button>
                    <button class="btn btn-success" onclick="validateForm()">
                        <i class="fa-solid fa-check-circle"></i> Validar
                    </button>
                    <button class="btn btn-warning" onclick="exportCarta('pdf')">
                        <i class="fa-solid fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-warning" onclick="exportCarta('docx')">
                        <i class="fa-solid fa-file-word"></i> Word
                    </button>
                    <button class="btn btn-success pulse" onclick="markComplete()">
                        <i class="fa-solid fa-trophy"></i> Completar
                    </button>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h2 class="section-title">
                <i class="fa-solid fa-info-circle"></i> 
                1. Informaci√≥n General del Curso
            </h2>
            <div class="grid-2">
                <div>
                    <label for="cd_nombre">Nombre del Curso/Taller *</label>
                    <input id="cd_nombre" placeholder="Ej: Dise√±o de cursos de capacitaci√≥n" required>
                </div>
                <div>
                    <label for="cd_duracion">Duraci√≥n total (horas) *</label>
                    <input id="cd_duracion" type="number" placeholder="Ej: 40" min="1" max="200" required>
                </div>
                <div>
                    <label for="cd_dise√±ador">Nombre del dise√±ador instruccional *</label>
                    <input id="cd_dise√±ador" placeholder="Nombre completo" required>
                </div>
                <div>
                    <label for="cd_facilitador">Nombre del facilitador/tutor *</label>
                    <input id="cd_facilitador" placeholder="Nombre completo" required>
                </div>
                 <div>
                    <label for="cd_modalidad">Modalidad *</label>
                    <select id="cd_modalidad" required>
                        <option value="">Seleccione...</option>
                        <option value="sincrono">En l√≠nea S√≠ncrono</option>
                        <option value="asincrono">En l√≠nea As√≠ncrono</option>
                        <option value="mixto">Mixto (S√≠ncrono y As√≠ncrono)</option>
                    </select>
                </div>
                <div>
                    <label for="cd_proposito">Prop√≥sito/Beneficio del curso *</label>
                    <textarea id="cd_proposito" placeholder="Describa el prop√≥sito y los beneficios del curso para el participante y la organizaci√≥n." required></textarea>
                </div>
            </div>
        </div>

        <div class="section">
             <h2 class="section-title"><i class="fa-solid fa-users"></i> 2. Perfil del Participante</h2>
            <div class="grid-2">
                <div>
                    <label for="cd_psico">Caracter√≠sticas psicogr√°ficas *</label>
                    <textarea id="cd_psico" placeholder="Edad, ocupaci√≥n, nivel educativo, experiencia previa, motivaciones..." required></textarea>
                </div>
                <div>
                    <label for="cd_conoc">Conocimientos previos requeridos *</label>
                    <textarea id="cd_conoc" placeholder="¬øQu√© debe saber el participante antes del curso?" required></textarea>
                </div>
                <div>
                    <label for="cd_hab">Habilidades tecnol√≥gicas requeridas *</label>
                    <textarea id="cd_hab" placeholder="¬øQu√© debe saber hacer? (Ej: Usar navegador, email, procesador de texto, plataforma LMS)" required></textarea>
                </div>
                <div>
                    <label for="cd_actitudes">Actitudes deseables</label>
                    <textarea id="cd_actitudes" placeholder="Disposici√≥n al aprendizaje, trabajo en equipo, autogesti√≥n..."></textarea>
                </div>
                <div>
                    <label for="cd_num">N√∫mero de participantes *</label>
                    <input id="cd_num" placeholder="Ej: 10-20 personas" required>
                </div>
                <div>
                    <label for="cd_tipo">Tipo de grupo *</label>
                    <select id="cd_tipo" required>
                        <option value="">Seleccione...</option>
                        <option value="homogeneo">Homog√©neo</option>
                        <option value="heterogeneo">Heterog√©neo</option>
                        <option value="mixto">Mixto</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title"><i class="fa-solid fa-bullseye"></i> 3. Objetivos de Aprendizaje</h2>
            <div class="box">
                <h3><i class="fa-solid fa-star"></i> Objetivo General <span class="help-tip" title="Debe cumplir criterios SMART">?</span></h3>
                <div class="grid-2">
                    <div>
                        <label>Sujeto</label>
                        <input value="Al finalizar el curso, el participante" disabled style="background: var(--light);">
                    </div>
                    <div>
                        <label>Dominio principal *</label>
                        <select id="og_dom" required onchange="updateOG()">
                            <option value="">Seleccione dominio...</option>
                            <option value="cognitivo">Cognitivo (Conocimiento)</option>
                            <option value="psicomotriz">Psicomotriz (Habilidades)</option>
                            <option value="afectivo">Afectivo (Actitudes)</option>
                            <option value="relacional">Relacional-Social</option>
                        </select>
                    </div>
                </div>
                <div class="mt-1"><label>Acci√≥n/Comportamiento observable *</label><textarea id="og_accion" placeholder="¬øQu√© podr√° hacer el participante? Use verbos en futuro (ser√° capaz de...)" required onkeyup="updateOG()"></textarea></div>
                <div class="mt-1"><label>Condici√≥n de operaci√≥n *</label><textarea id="og_cond" placeholder="¬øEn qu√© contexto o condiciones? (Ej: 'utilizando la plataforma LMS', 'a partir de los casos pr√°cticos...')" required onkeyup="updateOG()"></textarea></div>
                <div class="mt-1"><label>Criterio de evaluaci√≥n *</label><textarea id="og_criterio" placeholder="¬øC√≥mo se medir√° el logro? (Ej: 'cumpliendo con el 90% de la r√∫brica', 'sin errores...')" required onkeyup="updateOG()"></textarea></div>
                <div class="preview-box"><strong>Vista previa:</strong><div id="og_preview">Complete los campos para ver el objetivo...</div></div>
            </div>
            <div id="objetivosParticulares">
                <div class="box" data-op="1">
                    <h3><i class="fa-solid fa-tasks"></i> Objetivo Particular 1</h3>
                    <div class="doms">
                        <div class="dom active" data-op="1" data-d="cognitivo" onclick="selDom(1, 'cognitivo')">Cognitivo</div>
                        <div class="dom" data-op="1" data-d="psicomotriz" onclick="selDom(1, 'psicomotriz')">Psicomotriz</div>
                        <div class="dom" data-op="1" data-d="afectivo" onclick="selDom(1, 'afectivo')">Afectivo</div>
                        <div class="dom" data-op="1" data-d="relacional" onclick="selDom(1, 'relacional')">Relacional</div>
                    </div>
                    <div id="verbs1" style="margin: 0.75rem 0"></div>
                    <div class="grid-2">
                        <div><label>Verbo + Acci√≥n *</label><input id="op1_accion" placeholder="Ej: Identificar√° los elementos..." required></div>
                        <div><label>Condici√≥n/Contexto *</label><textarea id="op1_cond" placeholder="En qu√© condiciones..." required></textarea></div>
                    </div>
                    <div class="mt-1"><label>Temas relacionados</label><textarea id="op1_temas" placeholder="Liste los temas que apoyan este objetivo (uno por l√≠nea)"></textarea></div>
                    <div class="mt-1"><label>Tiempo estimado (minutos)</label><input type="number" id="op1_tiempo" placeholder="120" min="15"></div>
                </div>
            </div>
            <button class="btn btn-primary mt-1" onclick="addObjetivoParticular()"><i class="fa-solid fa-plus"></i> Agregar Objetivo Particular</button>
        </div>
        
        <div class="section">
            <h2 class="section-title"><i class="fa-solid fa-clipboard-list"></i> 4. Requerimientos del Curso (EC0301)</h2>
            <div class="grid-2">
                <div><label>Plataforma y Software *</label><textarea id="rq_plataforma" placeholder="LMS (Moodle, Blackboard, etc.), software de videoconferencia (Zoom, Teams), software especializado..." required></textarea></div>
                <div><label>Recursos Did√°cticos Digitales *</label><textarea id="rq_recursos" placeholder="Manual del participante (PDF), videos, paquetes SCORM, infograf√≠as, ligas web..." required></textarea></div>
                <div><label>Materiales de Evaluaci√≥n *</label><textarea id="rq_evaluacion" placeholder="Cuestionarios en l√≠nea, r√∫bricas para foros, listas de cotejo para proyectos..." required></textarea></div>
                <div><label>Requerimientos de Hardware (participante)</label><textarea id="rq_hardware" placeholder="Computadora con acceso a internet, c√°mara web, micr√≥fono..."></textarea></div>
                <div><label>Documentos Administrativos</label><textarea id="rq_admin" placeholder="Contrato de aprendizaje, lista de asistencia (logs), encuesta de satisfacci√≥n..."></textarea></div>
                <div><label>Recursos Humanos de Soporte</label><textarea id="rq_rh" placeholder="Tutor/Facilitador, soporte t√©cnico, administrador de plataforma..."></textarea></div>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title"><i class="fa-solid fa-chart-line"></i> 5. Sistema de Evaluaci√≥n</h2>
            <div class="box">
                <h3>Criterios generales</h3>
                <div class="grid-3">
                    <div><label>Calificaci√≥n m√≠nima aprobatoria *</label><select id="ev_min" required onchange="recalcEval()"><option value="">Seleccione...</option><option value="70">70%</option><option value="80" selected>80%</option><option value="85">85%</option><option value="90">90%</option></select></div>
                    <div><label>Escala de calificaci√≥n</label><select id="ev_escala"><option value="0-100">0-100</option><option value="0-10">0-10</option><option value="NA-S">NA/S (No Acreditado/Suficiente)</option></select></div>
                    <div><label>Tipo de acreditaci√≥n</label><select id="ev_cert"><option value="constancia">Constancia de participaci√≥n</option><option value="diploma">Diploma de acreditaci√≥n</option><option value="certificado">Certificado EC</option></select></div>
                </div>
            </div>
            <div class="box"><h3>Evaluaci√≥n Diagn√≥stica <span class="time">Inicio</span></h3><div class="grid-3"><input id="ev_diag_mom" placeholder="Momento (ej: M√≥dulo 0)" value="M√≥dulo 0 - Inicio"><input id="ev_diag_ins" placeholder="Instrumento (ej: cuestionario en l√≠nea)" value="Cuestionario en plataforma"><input id="ev_diag_prop" placeholder="Prop√≥sito" value="Identificar nivel inicial"></div></div>
            <div class="box"><h3>Evaluaci√≥n Formativa <span class="time">Durante</span></h3><div class="grid-3"><div><label>Ponderaci√≥n (%)</label><select id="ev_form_pct" onchange="recalcEval()"><option value="30">30%</option><option value="40" selected>40%</option><option value="50">50%</option><option value="60">60%</option></select></div><input id="ev_form_mom" placeholder="Momentos" value="Al finalizar cada m√≥dulo/tema"><input id="ev_form_ins" placeholder="Instrumentos" value="Foros, entrega de tareas, wikis"></div></div>
            <div class="box"><h3>Evaluaci√≥n Sumativa <span class="time">Final</span></h3><div class="grid-3"><div><label>Ponderaci√≥n (%)</label><input id="ev_sum_pct" placeholder="Calculado autom√°tico" disabled></div><input id="ev_sum_mom" placeholder="Momento" value="√öltimo m√≥dulo"><input id="ev_sum_ins" placeholder="Instrumentos" value="Examen final en l√≠nea, proyecto integrador"></div></div>
        </div>
        
        <div class="section">
            <h2 class="section-title"><i class="fa-solid fa-clock"></i> 6. Desarrollo Cronol√≥gico / Guion Instruccional (EC0301)</h2>
            <div class="box">
                <h3>Encuadre / M√≥dulo 0 <span class="time" id="encuadreTime">Variable</span></h3>
                <div class="mt-1"><label>Actividades de Encuadre (Inicio del curso)</label><textarea id="dc_integracion" placeholder="Bienvenida, presentaci√≥n de la plataforma, gu√≠a de navegaci√≥n, presentaci√≥n del tutor, foro social 'Cafeter√≠a', contrato de aprendizaje, evaluaci√≥n diagn√≥stica..."></textarea></div>
                <div class="mt-1"><label>Tiempo estimado (minutos)</label><input type="number" id="dc_encuadre_t" value="30" min="5" onchange="recalcTimes()"></div>
            </div>
            <div class="box">
                <h3>Desarrollo de contenidos <span class="time" id="desarrolloTime">Variable</span></h3>
                <div id="temasContainer"></div>
                <button class="btn btn-primary mt-1" onclick="addTema()"><i class="fa-solid fa-plus"></i> Agregar Tema/M√≥dulo</button>
            </div>
            <div class="box">
                <h3>Cierre / M√≥dulo Final <span class="time" id="cierreTime">Variable</span></h3>
                <textarea id="dc_cierre" placeholder="Resumen del curso, felicitaci√≥n, aplicaci√≥n de evaluaci√≥n sumativa, encuesta de satisfacci√≥n, siguientes pasos, descarga de constancias..."></textarea>
                <div class="mt-1"><label>Tiempo estimado (minutos)</label><input type="number" id="dc_cierre_t" value="60" min="15" onchange="recalcTimes()"></div>
            </div>
            <div class="box">
                <h3>Distribuci√≥n del tiempo total</h3>
                <div class="grid-3">
                    <div><label>Encuadre</label><input id="sum_encuadre" disabled></div>
                    <div><label>Desarrollo</label><input id="sum_desarrollo" disabled></div>
                    <div><label>Cierre</label><input id="sum_cierre" disabled></div>
                </div>
                <div class="mt-1" style="text-align: right;"><label>Total del curso (calculado)</label><input id="sum_total" disabled style="font-weight: bold; color: var(--primary); max-width: 200px; display: inline-block;"></div>
            </div>
        </div>
    </div>

    <div class="validation-indicator invalid" id="validationIndicator" style="display: none;">
        <i class="fa-solid fa-exclamation-circle" style="color: var(--danger);"></i>
        <span>Documento incompleto</span>
    </div>

    <script>
    // ========== CONSTANTES Y CONFIGURACI√ìN ==========
    // (AJUSTE) Cargar el DataManager desde el window global
    let EC0301Manager; 
    
    const KEY = 'EC0301_CARTA_PRO';
    const VERBOS = {
        cognitivo: {
            conocimiento: ['Identificar', 'Reconocer', 'Listar', 'Nombrar', 'Definir', 'Describir'],
            comprension: ['Explicar', 'Interpretar', 'Resumir', 'Clasificar', 'Comparar', 'Ejemplificar'],
            aplicacion: ['Aplicar', 'Usar', 'Implementar', 'Ejecutar', 'Resolver', 'Demostrar'],
            analisis: ['Analizar', 'Diferenciar', 'Organizar', 'Relacionar', 'Examinar', 'Contrastar'],
            evaluacion: ['Evaluar', 'Criticar', 'Justificar', 'Argumentar', 'Validar', 'Decidir'],
            creacion: ['Crear', 'Dise√±ar', 'Construir', 'Planear', 'Producir', 'Desarrollar']
        },
        psicomotriz: { 
            imitacion: ['Imitar', 'Copiar', 'Repetir', 'Reproducir', 'Seguir'],
            manipulacion: ['Manipular', 'Operar', 'Practicar', 'Ejecutar', 'Manejar'],
            precision: ['Demostrar', 'Completar', 'Mostrar', 'Calibrar', 'Controlar'],
            articulacion: ['Coordinar', 'Integrar', 'Adaptar', 'Modificar', 'Masterizar'],
            naturalizacion: ['Dise√±ar', 'Especificar', 'Gestionar', 'Inventar', 'Proyectar']
        },
        afectivo: {
            recepcion: ['Escuchar', 'Atender', 'Percibir', 'Recibir', 'Aceptar'],
            respuesta: ['Participar', 'Responder', 'Asistir', 'Practicar', 'Informar'],
            valoracion: ['Valorar', 'Apreciar', 'Justificar', 'Proponer', 'Compartir'],
            organizacion: ['Organizar', 'Integrar', 'Sintetizar', 'Priorizar', 'Combinar'],
            caracterizacion: ['Actuar', 'Discriminar', 'Influir', 'Modificar', 'Revisar']
        },
        relacional: { 
            interaccion: ['Interactuar', 'Comunicar', 'Relacionar', 'Contactar', 'Dialogar'],
            colaboracion: ['Colaborar', 'Cooperar', 'Contribuir', 'Ayudar', 'Apoyar'],
            liderazgo: ['Liderar', 'Dirigir', 'Guiar', 'Motivar', 'Inspirar'],
            negociacion: ['Negociar', 'Mediar', 'Conciliar', 'Acordar', 'Resolver'],
            facilitacion: ['Facilitar', 'Moderar', 'Coordinar', 'Dinamizar', 'Gestionar']
        }
    };

    // ========== UTILIDADES ==========
    const $ = id => document.getElementById(id);
    let objetivosCount = 1;
    let temasCount = 0;

    // ========== FUNCIONES DE NOTIFICACI√ìN ==========
    function toast(mensaje, tipo = 'success') {
        Swal.fire({
            toast: true, position: 'top-end', icon: tipo,
            title: mensaje, showConfirmButton: false, timer: 3000, timerProgressBar: true
        });
    }

    // ========== FUNCIONES DE VERBOS ==========
    function renderVerbos(n, dominio = 'cognitivo') {
        const container = $(`verbs${n}`);
        if (!container) return;
        let html = '<div style="margin-bottom: 0.5rem;"><small>Verbos sugeridos (clic para usar):</small></div>';
        const categorias = VERBOS[dominio] || VERBOS.cognitivo;
        for (const [categoria, verbos] of Object.entries(categorias)) {
            html += `<div style="margin: 0.5rem 0;">
                <strong style="color: var(--primary); font-size: 0.8rem;">${categoria.charAt(0).toUpperCase() + categoria.slice(1)}:</strong>
                ${verbos.map(v => `<span class="verbo" onclick="insertVerbo(${n}, '${v}')">${v}</span>`).join('')}
            </div>`;
        }
        container.innerHTML = html;
    }

    function insertVerbo(n, verbo) {
        const input = $(`op${n}_accion`);
        if (!input) return;
        const textoActual = input.value.trim();
        if (textoActual && !textoActual.startsWith(verbo)) {
            input.value = verbo + ' ' + textoActual.replace(/^[A-Z√Å√â√ç√ì√ö√ëa-z√°√©√≠√≥√∫√±]+\s*/, '');
        } else {
            input.value = verbo + ' ';
        }
        input.focus();
        updateProgress();
    }

    function selDom(n, dominio) {
        document.querySelectorAll(`[data-op="${n}"] .dom`).forEach(d => d.classList.remove('active'));
        document.querySelector(`[data-op="${n}"] .dom[data-d="${dominio}"]`)?.classList.add('active');
        renderVerbos(n, dominio);
        updateProgress();
    }

    // ========== OBJETIVOS ==========
    function updateOG() {
        const sujeto = 'Al finalizar el curso, el participante';
        const accion = $('og_accion').value.trim();
        const condicion = $('og_cond').value.trim();
        const criterio = $('og_criterio').value.trim();
        let preview = sujeto;
        if (accion) preview += ' ' + accion;
        if (condicion) preview += ', ' + condicion;
        if (criterio) preview += ', ' + criterio;
        $('og_preview').innerHTML = preview + '.';
        updateProgress();
    }

    function addObjetivoParticular() {
        objetivosCount++;
        const container = $('objetivosParticulares');
        const newObj = document.createElement('div');
        newObj.className = 'box';
        newObj.setAttribute('data-op', objetivosCount);
        newObj.innerHTML = `
            <h3>
                <span><i class="fa-solid fa-tasks"></i> Objetivo Particular ${objetivosCount}</span>
                <button class="btn btn-secondary" style="float: right; padding: 0.25rem 0.5rem;" onclick="removeObjetivo(${objetivosCount})"><i class="fa-solid fa-trash"></i></button>
            </h3>
            <div class="doms">
                <div class="dom active" data-op="${objetivosCount}" data-d="cognitivo" onclick="selDom(${objetivosCount}, 'cognitivo')">Cognitivo</div>
                <div class="dom" data-op="${objetivosCount}" data-d="psicomotriz" onclick="selDom(${objetivosCount}, 'psicomotriz')">Psicomotriz</div>
                <div class="dom" data-op="${objetivosCount}" data-d="afectivo" onclick="selDom(${objetivosCount}, 'afectivo')">Afectivo</div>
                <div class="dom" data-op="${objetivosCount}" data-d="relacional" onclick="selDom(${objetivosCount}, 'relacional')">Relacional</div>
            </div>
            <div id="verbs${objetivosCount}" style="margin: 0.75rem 0"></div>
            <div class="grid-2">
                <div><label>Verbo + Acci√≥n *</label><input id="op${objetivosCount}_accion" placeholder="Ej: Aplicar√° las t√©cnicas..." required></div>
                <div><label>Condici√≥n/Contexto *</label><textarea id="op${objetivosCount}_cond" placeholder="En qu√© condiciones..." required></textarea></div>
            </div>
            <div class="mt-1"><label>Temas relacionados</label><textarea id="op${objetivosCount}_temas" placeholder="Liste los temas (uno por l√≠nea)"></textarea></div>
            <div class="mt-1"><label>Tiempo estimado (minutos)</label><input type="number" id="op${objetivosCount}_tiempo" placeholder="120" min="15" onchange="recalcTimes()"></div>
        `;
        container.appendChild(newObj);
        renderVerbos(objetivosCount, 'cognitivo');
        newObj.style.animation = 'slideUp 0.5s ease';
    }

    function removeObjetivo(n) {
        const totalObjetivos = document.querySelectorAll('#objetivosParticulares .box').length;
        if (totalObjetivos <= 1) {
            toast('Debe mantener al menos un objetivo particular', 'warning');
            return;
        }
        Swal.fire({
            title: '¬øEliminar objetivo?', text: 'Esta acci√≥n no se puede deshacer',
            icon: 'warning', showCancelButton: true, confirmButtonColor: '#EF4444',
            cancelButtonColor: '#6B7280', confirmButtonText: 'S√≠, eliminar', cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                document.querySelector(`[data-op="${n}"]`).remove();
                toast('Objetivo eliminado', 'info');
                updateProgress();
            }
        });
    }

    // ========== TEMAS (MODIFICADO PARA EC0301) ==========
    function addTema() {
        temasCount++;
        const container = $('temasContainer');
        const tema = document.createElement('div');
        tema.className = 'box';
        tema.setAttribute('data-tema', temasCount);
        tema.innerHTML = `
            <h3>
                <span>Tema/M√≥dulo ${temasCount}</span>
                <button class="btn btn-secondary" style="float: right; padding: 0.25rem 0.5rem;" onclick="removeTema(${temasCount})"><i class="fa-solid fa-trash"></i></button>
            </h3>
            <div class="grid-2">
                <div><label>Nombre del Tema/M√≥dulo *</label><input id="tema${temasCount}_nombre" placeholder="T√≠tulo del tema" required></div>
                <div><label>Duraci√≥n (minutos) *</label><input type="number" id="tema${temasCount}_duracion" placeholder="60" min="15" onchange="recalcTimes()" required></div>
            </div>
            <div class="mt-1"><label>Actividades de aprendizaje (en plataforma)</label><textarea id="tema${temasCount}_actividades" placeholder="Describa las actividades: leer PDF, ver video, participar en foro, completar tarea..."></textarea></div>
            <div class="grid-3 mt-1">
                <div><label>Recursos Did√°cticos Digitales</label><input id="tema${temasCount}_recursos" placeholder="Video 'Intro', PDF 'Cap 1', SCORM..."></div>
                <div><label>Interacci√≥n (Tutor-Participante)</label><select id="tema${temasCount}_interaccion"><option value="asincrona">As√≠ncrona (Foro, Email)</option><option value="sincrona">S√≠ncrona (Videoconferencia)</option><option value="ninguna">Ninguna (Autogestivo)</option></select></div>
                <div><label>Instrumento de Evaluaci√≥n</label><input id="tema${temasCount}_evaluacion" placeholder="Cuestionario M√≥dulo 1, R√∫brica Foro 1..."></div>
            </div>
        `;
        container.appendChild(tema);
        tema.style.animation = 'slideUp 0.5s ease';
        recalcTimes();
    }

    function removeTema(n) {
        Swal.fire({
            title: '¬øEliminar tema?', text: 'Esta acci√≥n no se puede deshacer',
            icon: 'warning', showCancelButton: true, confirmButtonColor: '#EF4444',
            cancelButtonColor: '#6B7280', confirmButtonText: 'S√≠, eliminar', cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                document.querySelector(`[data-tema="${n}"]`).remove();
                recalcTimes();
                toast('Tema eliminado', 'info');
            }
        });
    }

    // ========== C√ÅLCULOS ==========
    function recalcTimes() {
        const encuadre = parseInt($('dc_encuadre_t').value) || 0;
        $('sum_encuadre').value = `${encuadre} minutos`;
        $('encuadreTime').textContent = `${encuadre} min`;
        
        const cierre = parseInt($('dc_cierre_t').value) || 0;
        $('sum_cierre').value = `${cierre} minutos`;
        $('cierreTime').textContent = `${cierre} min`;

        let desarrollo = 0;
        document.querySelectorAll('[data-op] input[type="number"]').forEach(input => {
             if (input.id.includes('_tiempo')) { desarrollo += parseInt(input.value) || 0; }
        });
        document.querySelectorAll('[data-tema] input[type="number"]').forEach(input => {
             if (input.id.includes('_duracion')) { desarrollo += parseInt(input.value) || 0; }
        });
        $('sum_desarrollo').value = `${desarrollo} minutos`;
        $('desarrolloTime').textContent = `${desarrollo} min`;
        
        const total = encuadre + desarrollo + cierre;
        const horas = Math.floor(total / 60);
        const minutos = total % 60;
        $('sum_total').value = `${horas} horas ${minutos} minutos`;
        
        updateProgress();
    }

    function recalcEval() {
        const formPct = parseInt($('ev_form_pct').value) || 40;
        $('ev_sum_pct').value = (100 - formPct) + '%';
        updateProgress();
    }

    // ========== VALIDACI√ìN Y PROGRESO ==========
    function updateProgress() {
        // (AJUSTE) Asegurarse de que los campos existan antes de leerlos
        const campos = [
            'cd_nombre', 'cd_duracion', 'cd_dise√±ador', 'cd_facilitador',
            'cd_modalidad', 'cd_proposito', 'cd_psico', 'cd_conoc', 
            'cd_hab', 'cd_num', 'cd_tipo',
            'og_dom', 'og_accion', 'og_cond', 'og_criterio',
            'op1_accion', 'op1_cond',
            'rq_plataforma', 'rq_recursos', 'rq_evaluacion',
            'ev_min'
        ];
        
        let completados = 0;
        campos.forEach(id => {
            if ($(id) && $(id).value.trim()) completados++;
        });
        
        if ($('tema1_nombre') && $('tema1_nombre').value.trim()) completados++;
        
        const totalCampos = campos.length + 1; // +1 por el tema1
        const porcentaje = Math.round((completados / totalCampos) * 100);
        
        if ($('progressBar')) $('progressBar').style.width = porcentaje + '%';
        
        const indicator = $('validationIndicator');
        if (!indicator) return porcentaje;

        if (porcentaje >= 80) {
            indicator.className = 'validation-indicator valid';
            indicator.innerHTML = '<i class="fa-solid fa-check-circle" style="color: var(--success);"></i><span>Documento v√°lido</span>';
        } else {
            indicator.className = 'validation-indicator invalid';
            indicator.innerHTML = `<i class="fa-solid fa-exclamation-circle" style="color: var(--danger);"></i><span>${porcentaje}% completado</span>`;
        }
        indicator.style.display = 'flex';
        return porcentaje;
    }

    function validateForm() {
        const porcentaje = updateProgress();
        if (porcentaje < 80) {
            Swal.fire({
                title: 'Validaci√≥n',
                html: `<p>El documento est√° <strong>${porcentaje}% completo</strong>.</p><p>Se requiere al menos 80% para considerarlo v√°lido seg√∫n EC0301.</p>`,
                icon: 'warning', confirmButtonText: 'Entendido'
            });
        } else {
            Swal.fire({
                title: '¬°Documento v√°lido!',
                text: 'La carta descriptiva cumple con los requisitos del EC0301',
                icon: 'success', confirmButtonText: 'Excelente'
            });
        }
    }

    // ========== GUARDAR Y CARGAR ==========
    function collectData() {
        const data = {
            nombre: $('cd_nombre').value, duracion: $('cd_duracion').value, dise√±ador: $('cd_dise√±ador').value,
            facilitador: $('cd_facilitador').value, modalidad: $('cd_modalidad').value, proposito: $('cd_proposito').value,
            psico: $('cd_psico').value, conoc: $('cd_conoc').value, hab: $('cd_hab').value,
            actitudes: $('cd_actitudes').value, num: $('cd_num').value, tipo: $('cd_tipo').value,
            og: { dom: $('og_dom').value, accion: $('og_accion').value, cond: $('og_cond').value, criterio: $('og_criterio').value },
            objetivos: [],
            rq: {
                plataforma: $('rq_plataforma').value, recursos: $('rq_recursos').value, evaluacion: $('rq_evaluacion').value,
                hardware: $('rq_hardware').value, admin: $('rq_admin').value, rh: $('rq_rh').value
            },
            ev: {
                min: $('ev_min').value, escala: $('ev_escala').value, cert: $('ev_cert').value,
                diag: { mom: $('ev_diag_mom').value, ins: $('ev_diag_ins').value, prop: $('ev_diag_prop').value },
                form: { pct: $('ev_form_pct').value, mom: $('ev_form_mom').value, ins: $('ev_form_ins').value },
                sum: { pct: $('ev_sum_pct').value, mom: $('ev_sum_mom').value, ins: $('ev_sum_ins').value }
            },
            dc: {
                integracion: $('dc_integracion').value, encuadre_t: $('dc_encuadre_t').value,
                cierre: $('dc_cierre').value, cierre_t: $('dc_cierre_t').value
            },
            temas: [],
            fechaActualizacion: new Date().toISOString()
        };
        
        document.querySelectorAll('[data-op]').forEach(box => {
            const n = box.dataset.op;
            if ($(`op${n}_accion`)) {
                data.objetivos.push({
                    num: n, dom: document.querySelector(`[data-op="${n}"] .dom.active`)?.dataset.d || 'cognitivo',
                    accion: $(`op${n}_accion`).value, cond: $(`op${n}_cond`).value,
                    temas: $(`op${n}_temas`).value, tiempo: $(`op${n}_tiempo`)?.value || ''
                });
            }
        });
        
        document.querySelectorAll('[data-tema]').forEach(box => {
            const n = box.dataset.tema;
             if ($(`tema${n}_nombre`)) {
                data.temas.push({
                    num: n, nombre: $(`tema${n}_nombre`).value, duracion: $(`tema${n}_duracion`).value,
                    actividades: $(`tema${n}_actividades`).value, recursos: $(`tema${n}_recursos`).value,
                    interaccion: $(`tema${n}_interaccion`).value, evaluacion: $(`tema${n}_evaluacion`).value
                });
            }
        });
        return data;
    }

    function saveDraft() {
        if (!EC0301Manager) {
            toast('Error: M√≥dulo de datos no cargado', 'error');
            return;
        }
        try {
            const data = collectData();
            EC0301Manager.saveData(data, 'carta-descriptiva');
            toast('Carta descriptiva guardada', 'success');
            updateProgress();
        } catch (e) {
            toast(`Error al guardar: ${e.message}`, 'error');
        }
    }

    function loadDraft() {
         if (!EC0301Manager) {
            toast('Error: M√≥dulo de datos no cargado', 'error');
            return;
        }
        try {
            const data = EC0301Manager.getData();
            if (!data.nombre && !data.facilitador) { // (AJUSTE) Checar si est√° realmente vac√≠o
                toast('No hay datos guardados para cargar', 'info');
                return;
            }
            
            // Cargar informaci√≥n general
            $('cd_nombre').value = data.nombre || '';
            $('cd_duracion').value = data.duracion || '';
            $('cd_dise√±ador').value = data.dise√±ador || '';
            $('cd_facilitador').value = data.facilitador || '';
            $('cd_modalidad').value = data.modalidad || '';
            $('cd_proposito').value = data.proposito || '';

            $('cd_psico').value = data.psico || '';
            $('cd_conoc').value = data.conoc || '';
            $('cd_hab').value = data.hab || '';
            $('cd_actitudes').value = data.actitudes || '';
            $('cd_num').value = data.num || '';
            $('cd_tipo').value = data.tipo || '';
            
            if (data.og) {
                $('og_dom').value = data.og.dom || '';
                $('og_accion').value = data.og.accion || '';
                $('og_cond').value = data.og.cond || '';
                $('og_criterio').value = data.og.criterio || '';
                updateOG();
            }
            
            if (data.rq) {
                $('rq_plataforma').value = data.rq.plataforma || '';
                $('rq_recursos').value = data.rq.recursos || '';
                $('rq_evaluacion').value = data.rq.evaluacion || '';
                $('rq_hardware').value = data.rq.hardware || '';
                $('rq_admin').value = data.rq.admin || '';
                $('rq_rh').value = data.rq.rh || '';
            }
            
            if (data.ev) {
                $('ev_min').value = data.ev.min || '80';
                $('ev_escala').value = data.ev.escala || '0-100';
                $('ev_cert').value = data.ev.cert || 'constancia';
                if (data.ev.diag) {
                    $('ev_diag_mom').value = data.ev.diag.mom || '';
                    $('ev_diag_ins').value = data.ev.diag.ins || '';
                    $('ev_diag_prop').value = data.ev.diag.prop || '';
                }
                if (data.ev.form) {
                    $('ev_form_pct').value = data.ev.form.pct || '40';
                    $('ev_form_mom').value = data.ev.form.mom || '';
                    $('ev_form_ins').value = data.ev.form.ins || '';
                }
                if (data.ev.sum) {
                    $('ev_sum_pct').value = data.ev.sum.pct || '60%';
                    $('ev_sum_mom').value = data.ev.sum.mom || '';
                    $('ev_sum_ins').value = data.ev.sum.ins || '';
                }
            }
            
            if (data.dc) {
                $('dc_integracion').value = data.dc.integracion || '';
                $('dc_encuadre_t').value = data.dc.encuadre_t || '30';
                $('dc_cierre').value = data.dc.cierre || '';
                $('dc_cierre_t').value = data.dc.cierre_t || '60';
            }
            
            if (data.objetivos && data.objetivos.length > 0) {
                $('objetivosParticulares').innerHTML = '';
                objetivosCount = 0; 
                data.objetivos.forEach(obj => {
                    objetivosCount = obj.num - 1; 
                    addObjetivoParticular();
                    $(`op${obj.num}_accion`).value = obj.accion || '';
                    $(`op${obj.num}_cond`).value = obj.cond || '';
                    $(`op${obj.num}_temas`).value = obj.temas || '';
                    $(`op${obj.num}_tiempo`).value = obj.tiempo || '';
                    selDom(obj.num, obj.dom || 'cognitivo');
                });
            }
            
            if (data.temas && data.temas.length > 0) {
                $('temasContainer').innerHTML = '';
                temasCount = 0; 
                data.temas.forEach(tema => {
                    temasCount = tema.num - 1; 
                    addTema();
                    $(`tema${tema.num}_nombre`).value = tema.nombre || '';
                    $(`tema${tema.num}_duracion`).value = tema.duracion || '';
                    $(`tema${tema.num}_actividades`).value = tema.actividades || '';
                    $(`tema${tema.num}_recursos`).value = tema.recursos || '';
                    $(`tema${tema.num}_interaccion`).value = tema.interaccion || 'asincrona';
                    $(`tema${tema.num}_evaluacion`).value = tema.evaluacion || '';
                });
            }
            
            recalcTimes();
            recalcEval();
            updateProgress();
            toast('Datos cargados correctamente', 'success');
        } catch (error) {
            console.error(error);
            toast('Error al cargar los datos', 'error');
        }
    }

    // ========== EXPORTACI√ìN ==========
    // (AJUSTE) Funci√≥n exportPDF simplificada para brevedad, usa tu versi√≥n
    async function exportCarta(formato) { 
        if (updateProgress() < 80) {
            const result = await Swal.fire({
                title: 'Documento incompleto', text: '¬øDesea exportar de todas formas?',
                icon: 'warning', showCancelButton: true, confirmButtonText: 'S√≠, exportar'
            });
            if (!result.isConfirmed) return;
        }
        if (formato === 'pdf') toast('Generando PDF...', 'info');
        if (formato === 'docx') toast('Generando DOCX...', 'info');
    }

    // ========== AYUDA ==========
    function showHelp() { 
        Swal.fire({
            title: 'Gu√≠a R√°pida EC0301',
            html: `<div style="text-align: left;">
                    <h4>üìù Guion Instruccional (EC0301)</h4>
                    <p>Este formulario te ayuda a crear el guion instruccional (carta descriptiva) para un <strong>curso en l√≠nea</strong>, seg√∫n el est√°ndar EC0301.</p>
                    <h5 style="margin-top: 1rem;">‚úÖ Elementos clave:</h5>
                    <ul>
                        <li><strong>Perfil:</strong> Debe incluir habilidades tecnol√≥gicas.</li>
                        <li><strong>Requerimientos:</strong> Enfocados en plataforma y recursos digitales.</li>
                        <li><strong>Guion:</strong> Detalla actividades <strong>en plataforma</strong> y tipo de interacci√≥n (s√≠ncrona/as√≠ncrona).</li>
                    </ul>
                   </div>`,
            width: 600, confirmButtonText: 'Entendido', confirmButtonColor: '#1E3A8A'
        });
    }

    // ========== COMPLETAR ==========
    async function markComplete() {
        if (updateProgress() < 80) {
            await Swal.fire({
                title: 'Documento incompleto', text: 'Se requiere m√≠nimo 80%.',
                icon: 'warning', confirmButtonText: 'Entendido'
            });
            return;
        }
        
        const result = await Swal.fire({
            title: '¬øMarcar como completado?', text: 'Esto guardar√° la carta y la marcar√° como completa en el dashboard.',
            icon: 'question', showCancelButton: true, confirmButtonText: 'S√≠, completar',
            cancelButtonText: 'Cancelar', confirmButtonColor: '#22C55E'
        });
        
        if (result.isConfirmed) {
            saveDraft(); 
            Swal.fire({
                title: '¬°Completado!', text: 'La carta descriptiva ha sido marcada como completa. Ser√°s redirigido al dashboard.',
                icon: 'success', confirmButtonText: 'Excelente', timer: 2000, timerProgressBar: true
            }).then(() => {
                window.location.href = 'index.html'; // Volver al dashboard
            });
        }
    }

    // ========== INICIALIZACI√ìN ==========
    document.addEventListener('DOMContentLoaded', () => {
        // (AJUSTE) Verificar que los scripts globales est√©n cargados
        if (typeof auth === 'undefined' || typeof EC0301Manager === 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'Error Cr√≠tico',
                text: 'No se pudieron cargar los m√≥dulos de sistema (auth.js, ec0301-data-manager.js). Revisa las rutas en el HTML.',
                confirmButtonColor: '#EF4444'
            }).then(() => window.location.href = 'index.html'); // Regresar si falla
            return;
        }
        
        // (NUEVO) Proteger la p√°gina
        if (!auth.isLoggedIn()) {
            Swal.fire({
                icon: 'error',
                title: 'Acceso Denegado',
                text: 'Debes iniciar sesi√≥n para acceder a este m√≥dulo.',
                confirmButtonColor: '#1E3A8A',
                allowOutsideClick: false
            }).then(() => {
                window.location.href = 'index.html'; // Redirigir al dashboard para login
            });
            return;
        }

        // Si el login es correcto, cargar el manager y la p√°gina
        EC0301Manager = window.EC0301Manager;
        renderVerbos(1, 'cognitivo');
        addTema(); 
        loadDraft(); // Cargar datos existentes al iniciar
        recalcTimes();
        recalcEval();
        updateProgress();
    });
    </script>
</body>
</html>
